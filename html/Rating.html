<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" href="../css/mbase.css" />
    <link rel="stylesheet" href="../css/mrating.css" />
    <link rel="stylesheet" href="../css/mbutton.css" />
    <title></title>
</head>
<body>
    <div>Static</div>
    <div class="m-rating" data-role="m-rating" data-stars="5" id="static-1">
        <div class="m-rating-score"></div>
    </div>
    <button class="m-button bg-color-green" data-for="#static-1" data-fun="setScore" data-param="70">SetScore To 70%</button>
    <div>Static Small</div>
    <div class="m-rating-small" data-role="m-rating-small" data-stars="5">
        <div class="m-rating-small-score"></div>
    </div>
    <div>Rating</div>
    <div class="m-rating" data-role="m-rating" id="m-rating-1">
    </div>
    <button class="m-button bg-color-blue" data-for="#m-rating-1" data-fun="getScore" data-param="">Get Score</button>
    <div>Small Rating</div>
    <div class="m-rating-small" data-role="m-rating-small" id="disable">
    </div>
    <button class="m-button bg-color-blue" data-for="#disable" data-fun="disableRating" data-param="">Disable Rating</button>
    <button class="m-button bg-color-blue" data-for="#disable" data-fun="enableRating" data-param="">Enable Rating</button>
    <div>Current Score:<span id="Rating" class="fg-color-darkred">0</span></div>
    <script src="../js/jquery-1.8.1.min.js"></script>
    <script>
        (function($){
            $.fn.mRating = function(opt){

                var defaults = {
                    total_stars:5,
                    onrating:null,
                    onfinish:null
                },
                DATAINDEX = 'data-index',
                TOTALSTARS = 'data-t-st',
                TOTALSCORE = 'data-t-sc',
                DISABLE = 'data-disable',
                options = $.extend({},defaults,opt),
                _this = this,
                api = {
                    //获取评分
                    getScore : function(){
                        var index = _this.data(DATAINDEX);
                        return getScoreByIndex(typeof index !== 'undefined' ? index : -1)
                    },
                    //设置分数,仅用于评分未开启的情况
                    setScore : function(args){
                        _this.data(DATAINDEX, args / 100)
                             .children('.m-rating-score,m-rating-small-score')
                             .animate({'width':args+'%'},800);
                        return args / 100 * 10
                    },
                    //禁用评分
                    disableRating : function(){
                        _this.data(DISABLE,false);
                    },
                    //启用评分
                    enableRating : function(){
                        _this.data(DISABLE,true);
                    }
                };
                if(typeof opt === 'string'){
                    var args = Array.prototype.slice.call(arguments,1);
                    if(api[opt]){
                        return api[opt](args)
                    }
                    return this
                }

                function moveRating(type, index, $this){
                    $('.'+type+'-item',$this).removeClass(type+'-final');
                    $('.'+type+'-item:lt('+(index+1)+')',$this).addClass(type+'-hover');
                    $('.'+type+'-item:gt('+index+')',$this).removeClass(type+'-hover');
                    (typeof options.onrating === 'function') && options.onrating(getScoreByIndex(index));
                }
                function getScoreByIndex(stars){
                    return 10 * (stars + 1) / (_this.data(TOTALSTARS) || options.total_stars);
                }
                function clearRating(type, $this){
                    var dataindex = $this.data(DATAINDEX);
                    var index = typeof dataindex === 'undefined' ? -1 : parseInt(dataindex);
                    $('.'+type+'-item:gt('+index+')',$this).removeClass(type+'-hover');
                    $('.'+type+'-item:lt('+(index + 1)+')',$this).addClass(type+'-final');
                }
                return this.each(function(){
                    var i= 0,
                        $this = $(this)
                                .data(TOTALSCORE,10)
                                .data(TOTALSTARS,options.total_stars),
                        items = $this.find('.m-rating-item,.m-rating-small-item'),
                        len = parseInt($this.attr('data-stars')) || options.total_stars,
                        type = $this.attr('data-role'),
                        width = (/small/.test(type) ? 14 : 27 ) * len,
                        itemArr = [],
                        static = $this.find('.'+type+'-score').length;
                    if(static > 0){
                        $this.width(width);
                        return;
                    }
                    for(; i < len; i+=1){
                        itemArr.push('<div class="'+type+'-item" href="javascript:void(0);"></div>')
                    }
                    if(len > 0){
                        $this.html('').append(itemArr.join('')).width(width);
                        items = $this.find('.m-rating-item,.m-rating-small-item')
                    }

                    items.each(function(i){
                        $(this).bind(
                            'mouseover.mrating',
                            function(){
                                ($this.data(DISABLE) !== false) && moveRating(type,i,$this)
                            }
                        ).bind(
                            'click.mrating',
                            function(){
                                ($this.data(DISABLE) !== false) && $this.data(DATAINDEX,i);
                                (typeof options.onfinish === 'function') && options.onfinish(getScoreByIndex(i));
                            }
                        )
                    });
                    $this.bind('mouseout.mrating',function(){
                        ($this.data(DISABLE) !== false) && clearRating(type,$this);
                    })

                })
            }

            $('[data-role*="m-rating"]').mRating({
                total_stars:5,
                onrating:function(score){
                    $('#Rating').text(score)
                },
                onfinish:function(score){
                    alert('Your Score:'+score)
                }
            });

            $('.m-button').click(function(){
                var _this = $(this),
                    forEle = $(_this.attr('data-for')),
                    fun = _this.attr('data-fun'),
                    param = _this.attr('data-param'),
                    result = forEle.mRating(fun,param);
                (typeof result !=='undefined') && alert( result + '分');
            })
        })(jQuery)
    </script>
</body>
</html>